definitions:
  services:
    postgres:
      image: postgres
      environment:
        POSTGRES_DB: test_audio_db
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: kidsloop
  caches:
    nodemodules: ./node_modules
  steps:
    - step: &commitlint-check
        name: 'Conventional Commits check'
        image: node:lts
        script:
          - /bin/bash commitlint-pipeline-check.sh
    - step: &npm-install-and-test
        name: 'Install npm dependencies and run tests'
        image: node:lts
        services:
          - postgres
          - docker
        script:
          - >
            docker run
            -d
            -p 9000:9000
            -p 9001:9001
            -e "MINIO_ACCESS_KEY=minio"
            -e "MINIO_SECRET_KEY=minio123"
            minio/minio server /data --console-address ":9001"
          - export HUSKY=0
          - npm i
          - CI=true npm run test:codecov
        caches:
          - nodemodules
        artifacts:
          - node_modules/**
    - step: &slack-notification
        name: Slack Notification
        script:
          - pipe: atlassian/slack-notify:1.0.1
            variables:
              WEBHOOK_URL: $SLACK_WEBHOOK
              MESSAGE: 'A new build of Audio Service ($BITBUCKET_COMMIT) has been push with the "$BITBUCKET_BRANCH" tag'

  script: &build-and-push-to-aws
    - pip3 install -U awscli

    - export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_KEY" AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY"
    - export BRANCH_TAG=$(echo "$BITBUCKET_BRANCH" | sed -E 's/([^0-9a-zA-Z]+)/-/g' | awk '{print tolower($0)}')
    - export REPO=$DOCKER_REPO_URL/audio-storage # DOCKER_REPO_URL is workspace wide variable
    - export COMMIT_TAG=$(echo $BITBUCKET_COMMIT | cut -c1-7)
    - printf '"Git tag":"%s", "Git commit":"%s" "ECR repo":"%s"' $BRANCH_TAG $COMMIT_TAG $REPO
    - export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" $(aws sts assume-role --role-arn arn:aws:iam::942095822719:role/cross_account_role_ecr_push --role-session-name MySessionName --query "Credentials.[AccessKeyId,SecretAccessKey,SessionToken]" --output text))
    - aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin $DOCKER_REPO_URL

    - docker build -t audio-storage .

    - docker tag audio-storage:latest $REPO:$BRANCH_TAG
    - docker tag audio-storage:latest $REPO:$BRANCH_TAG-latest
    - docker tag audio-storage:latest $REPO:$BRANCH_TAG-$BITBUCKET_BUILD_NUMBER
    - docker tag audio-storage:latest $REPO:$BRANCH_TAG-$COMMIT_TAG

    - docker push $REPO:$BRANCH_TAG
    - docker push $REPO:$BRANCH_TAG-latest
    - docker push $REPO:$BRANCH_TAG-$BITBUCKET_BUILD_NUMBER
    - docker push $REPO:$BRANCH_TAG-$COMMIT_TAG

pipelines:
  pull-requests:
    '**': # This runs as default for any branch not elsewhere defined.:
      - step: *npm-install-and-test
      - step: *commitlint-check

  branches:
    main:
      - step: *npm-install-and-test
    alpha:
      - step: *npm-install-and-test
      - step:
          name: 'Run npm build'
          image: node:lts
          script:
            - npm run build
          artifacts:
            - dist/**
      - step:
          name: 'Docker build and push to AWS'
          deployment: alpha
          image: python:3.9-alpine
          services:
            - docker
          script: *build-and-push-to-aws
    production:
      - step: *npm-install-and-test
      - step:
          name: 'Run npm build'
          image: node:lts
          script:
            - npm run build
          artifacts:
            - dist/**
      - step:
          name: 'Docker build and push to AWS'
          deployment: production
          image: python:3.9-alpine
          services:
            - docker
          script: *build-and-push-to-aws
      - step: *slack-notification
